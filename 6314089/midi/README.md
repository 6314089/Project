# 正答率確認プログラム

出力されたものとmidiを比較してどの程度正しく音を取れているかを表示するプログラム．

各ノードのなりはじめの時刻しか見ていない．音の長さについては考慮していない．
出力されたものとmidiの方とで音の鳴りはじめの位置が同じくらいならば，そのノートはきちんと検出することができたものとして評価する．

もっとちゃんとした評価が必要ならば手助けが欲しい．

だいぶ力技かつ読みにくいコードだけど動くことは動くと思われる．
midiのノートのデータを配列にしてその配列をコピーしたりなどなど，割メモリを大量に使っているのでmidiのファイルのサイズによっては上手く動かないかもしれない．テストしていない為不明．

入力はこちらが用意したcsvのフォーマットに合わせてほしい．
扱いにく文字列を使う気力が起きなかったので，
こちらが使いやすいようなcsvのフォーマットを指定させてもらった．

## 使い方

### 準備

最新版のNode.jsがインストールされている必要がある．

以下のコマンドを叩く．

```
$git clone https://github.com/6314089/Project
$cd Project/6314089/midi
$npm install
```

これで必要なパッケージなどが一通りインストールされる．

### 実行

以下のコマンドを叩くことで実行される．

```
$npm start <targetDir>
```

`<targetDir>`の部分は後述するデータの入ったディレクトリを文字列で指定する．

例

```
$npm start './testData'
```

### <targetDir>

`targetDir`は以下の構成である必要がある．

```
targetDir
├bass
│├0.csv
│├1.csv
│...
│├126.csv
│└127.csv
├drums
│├0.csv
│├1.csv
│...
│├126.csv
│└127.csv
├piano
│├0.csv
│├1.csv
│...
│├126.csv
│└127.csv
├config.json
└<filename>.mid
```

各パートの各音高はcsvファイルにしてそれぞれのディレクトリに入れる．

C-1からG9までを0から127に割り当てて，
0.csvから127.csvを各パートごとに用意する．
60.csvがC4の音のデータになっている．
ただし，音が一切なっていない音高についてはcsvファイルは存在しなくても良い．

####各csvファイル

csvファイルは以下の形式である必要がある．

```
<鳴り始めの時刻[ms]>,<鳴り終わりの時刻[ms]>
<鳴り始めの時刻[ms]>,<鳴り終わりの時刻[ms]>
<鳴り始めの時刻[ms]>,<鳴り終わりの時刻[ms]>
...
```

一行につき1ノートの情報が書かれている．
鳴りはじめの時刻と鳴り終わりの時刻が`,`区切りで並べられている．
時刻はミリ秒の数値である．
ノートの数だけ行数を増やす．
空白文字などは受け付けない．

ドラムのような音高のない楽器は，各楽器のmidi上でのノートの音程を参照すること．


####config.json

config.jsonは以下の通りの形式である必要がある．

```
{
  "midifileName": <filename>,
  "channelNumber": {
    "piano": <channel>,
    "bass": <channel>,
    "drums": <channel>
  },
  "error": <error>
}
```

`<filename>`はmidiファイルの名前である．`<targetDir>/aaa.mid`にmidiファイルを配置した場合，`<filename>`は`aaa.mid`になる．
文字列で指定する．

`<channel>`はそれぞれのパートのmidi上でのchannelナンバーである．
何番のチャンネルがどのパートであるかを指定する．
それぞれ整数値．

`<error>`は何ミリ秒の誤差まで同一の音符として許容するかを指定する．
整数値．


## 例

`<targetDir>`の例として`/6314089/midi/testData`が用意してある．

### `/6314089/midi/testData`の構造

`/6314089/midi/testData`の構造は以下の通り．

```
testData
├bass
│├40.csv
│├43.csv
│└48.csv
├drums
│├36.csv
│├38.csv
│└39.csv
├piano
│├60.csv
│└64.csv
├config.json
└test.mid
```

### `config.json`の構造

`config.json`は以下の通り．

```
{
  "midifileName": "test.mid",
  "channelNumber": {
    "piano": 0,
    "bass": 1,
    "drums": 9
  },
  "error": 100
}
```

100ミリ秒までの誤差を許容している．
test.midを元データのmidiとして指定している．
test.midでは0番チャンネルがpianoパート，1番チャンネルがbassパート，
9番がドラムパートだったので，そのような指定となっている．


### 各csvファイルの中身

各csvファイルは以下の通り．

#### bass以下のcsvの中身

まずはbass以下．

- bass/40.csv

```
0,1000

```

- bass/43.csv

```
1000,2000
3000,4000

```

- bass/48.csv

```
2000,3000

```

ベースパートはこの三種類の音しか鳴っていないので，
csvファイルはこの3種類だけで他に用意する必要はない．
E2->G2->C3->G2の順で1秒ずつ鳴っている．

#### piano以下のcsvの中身

次にpiano以下．

- piano/60.csv

```
0,500
1000,1500

```

- piano/64.csv

```
2000,2500
3000,3500

```

ピアノパートは2音しか鳴っていないのでcsvファイルも2つだけ．
間に一拍休みをはさみつつC4->C4->G4->G4と鳴っている．

#### drums以下のcsvの中身

最後にdrums以下．

- drums/36.csv

```
0,1.0416666666666667
1000,1001.0416666666666
2000,2001.0416666666667
3000,3001.0416666666665

```

- drums/38.csv

```
0,1.0416666666666667
250,251.04166666666666
500,501.0416666666667
750,751.0416666666666
1000,1001.0416666666666
1250,1251.0416666666667
1500,1501.0416666666667
1750,1751.0416666666667
2000,2001.0416666666667
2250,2251.0416666666665
2500,2501.0416666666665
2750,2751.0416666666665
3000,3001.0416666666665
3250,3251.0416666666665
3500,3501.0416666666665
3750,3751.0416666666665

```

- drums/39.csv

```
500,501.0416666666667
1500,1501.0416666666667
2500,2501.0416666666665
3500,3501.0416666666665

```

リズムを刻んでいるのでノードの数が多い．

これらのcsvファイルが我々のプロジェクト課題のプログラムから出力されるものとする．

### 実行

```
$npm start './testData'
```

### 結果

```
> midi@1.0.0 start C:\Users\user\.ghq\github.com\6314089\Project\6314089\midi
> node ./index.js "./testData"

pianoパート
全ノート数:                     4
正しく検出できたノート数:       4
検出できなかったノート数:       0
余計に検出してしまったノート数: 0

bassパート
全ノート数:                     4
正しく検出できたノート数:       4
検出できなかったノート数:       0
余計に検出してしまったノート数: 0

drumsパート
全ノート数:                     24
正しく検出できたノート数:       24
検出できなかったノート数:       0
余計に検出してしまったノート数: 0

全パート合計
全ノート数:                     32
正しく検出できたノート数:       32
検出できなかったノート数:       0
余計に検出してしまったノート数: 0
```


全ノート数というのがmidiファイルのノート数．

midiファイルのノートのうち，csvの方にも存在したものを「正しく検出できたノート数」としてカウントしている．

midiファイルのノートのうち，csvの方に存在しなかったものを「検出できなかったノート数」としてカウントしている．

「全ノート数」 = 「正しく検出できたノート数」 + 「検出できなかったノート数」

余計に検出してしまったノート数というのは，midiの方には存在しないが，csvの方には存在してしまったノート数である．



## 使用ライブラリ

- [nfroidure/MIDIFile](https://github.com/nfroidure/MIDIFile)
- [lodash](https://lodash.com/)
